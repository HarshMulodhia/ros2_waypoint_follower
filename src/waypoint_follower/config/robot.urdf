<?xml version="1.0"?>
<robot name="autonomous_waypoint_follower" xmlns:xacro="http://www.ros.org/wiki/xacro">
  
  <!-- ============================================
       AUTONOMOUS WAYPOINT FOLLOWER
       Differential Drive Mobile Robot
       ============================================ -->
  
  <!-- ========== CONSTANTS & PROPERTIES ========== -->
  <xacro:property name="PI" value="3.14159265358979"/>
  
  <!-- Chassis dimensions (meters) -->
  <xacro:property name="chassis_length" value="0.6"/>
  <xacro:property name="chassis_width" value="0.45"/>
  <xacro:property name="chassis_height" value="0.35"/>
  <xacro:property name="chassis_mass" value="8.0"/>
  
  <!-- Wheel specifications -->
  <xacro:property name="wheel_radius" value="0.125"/>
  <xacro:property name="wheel_length" value="0.12"/>
  <xacro:property name="wheel_mass" value="0.75"/>
  <xacro:property name="wheel_separation" value="0.38"/>
  
  <!-- Caster wheel specs -->
  <xacro:property name="caster_radius" value="0.06"/>
  <xacro:property name="caster_mass" value="0.2"/>
  
  <!-- ========== INERTIA CALCULATIONS ========== -->
  <xacro:macro name="box_inertia" params="mass x y z">
    <inertia ixx="${mass * (y*y + z*z) / 12}" ixy="0" ixz="0"
             iyy="${mass * (x*x + z*z) / 12}" iyz="0"
             izz="${mass * (x*x + y*y) / 12}"/>
  </xacro:macro>
  
  <xacro:macro name="cylinder_inertia" params="mass radius length">
    <inertia ixx="${mass * (3*radius*radius + length*length) / 12}" ixy="0" ixz="0"
             iyy="${mass * (3*radius*radius + length*length) / 12}" iyz="0"
             izz="${mass * radius*radius / 2}"/>
  </xacro:macro>
  
  <xacro:macro name="sphere_inertia" params="mass radius">
    <inertia ixx="${2*mass*radius*radius / 5}" ixy="0" ixz="0"
             iyy="${2*mass*radius*radius / 5}" iyz="0"
             izz="${2*mass*radius*radius / 5}"/>
  </xacro:macro>
  
  <!-- ========== BASE LINK (CHASSIS) ========== -->
  <link name="base_link">
    <inertial>
      <mass value="${chassis_mass}"/>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <xacro:box_inertia mass="${chassis_mass}" 
                         x="${chassis_length}" 
                         y="${chassis_width}" 
                         z="${chassis_height}"/>
    </inertial>
    
    <visual>
      <geometry>
        <box size="${chassis_length} ${chassis_width} ${chassis_height}"/>
      </geometry>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <material name="chassis_blue">
        <color rgba="0.05 0.3 0.8 1.0"/>
      </material>
    </visual>
    
    <collision>
      <geometry>
        <box size="${chassis_length} ${chassis_width} ${chassis_height}"/>
      </geometry>
      <origin xyz="0 0 0" rpy="0 0 0"/>
    </collision>
  </link>
  
  <!-- ========== LEFT WHEEL ========== -->
  <link name="left_wheel">
    <inertial>
      <mass value="${wheel_mass}"/>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <xacro:cylinder_inertia mass="${wheel_mass}" 
                              radius="${wheel_radius}" 
                              length="${wheel_length}"/>
    </inertial>
    
    <visual>
      <geometry>
        <cylinder radius="${wheel_radius}" length="${wheel_length}"/>
      </geometry>
      <origin xyz="0 0 0" rpy="1.5708 0 0"/>
      <material name="wheel_black">
        <color rgba="0.15 0.15 0.15 1.0"/>
      </material>
    </visual>
    
    <collision>
      <geometry>
        <cylinder radius="${wheel_radius}" length="${wheel_length}"/>
      </geometry>
      <origin xyz="0 0 0" rpy="1.5708 0 0"/>
    </collision>
  </link>
  
  <!-- ========== RIGHT WHEEL ========== -->
  <link name="right_wheel">
    <inertial>
      <mass value="${wheel_mass}"/>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <xacro:cylinder_inertia mass="${wheel_mass}" 
                              radius="${wheel_radius}" 
                              length="${wheel_length}"/>
    </inertial>
    
    <visual>
      <geometry>
        <cylinder radius="${wheel_radius}" length="${wheel_length}"/>
      </geometry>
      <origin xyz="0 0 0" rpy="1.5708 0 0"/>
      <material name="wheel_black">
        <color rgba="0.15 0.15 0.15 1.0"/>
      </material>
    </visual>
    
    <collision>
      <geometry>
        <cylinder radius="${wheel_radius}" length="${wheel_length}"/>
      </geometry>
      <origin xyz="0 0 0" rpy="1.5708 0 0"/>
    </collision>
  </link>
  
  <!-- ========== FRONT CASTER WHEEL ========== -->
  <link name="caster_wheel">
    <inertial>
      <mass value="${caster_mass}"/>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <xacro:sphere_inertia mass="${caster_mass}" radius="${caster_radius}"/>
    </inertial>
    
    <visual>
      <geometry>
        <sphere radius="${caster_radius}"/>
      </geometry>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <material name="caster_gray">
        <color rgba="0.5 0.5 0.5 1.0"/>
      </material>
    </visual>
    
    <collision>
      <geometry>
        <sphere radius="${caster_radius}"/>
      </geometry>
      <origin xyz="0 0 0" rpy="0 0 0"/>
    </collision>
  </link>
  
  <!-- ========== SENSOR LINKS ========== -->
  <link name="imu_link"/>
  
  <link name="laser_link">
    <inertial>
      <mass value="0.05"/>
      <inertia ixx="0.001" ixy="0" ixz="0" iyy="0.001" iyz="0" izz="0.001"/>
    </inertial>
    <visual>
      <geometry>
        <cylinder radius="0.02" length="0.04"/>
      </geometry>
      <material name="laser_red">
        <color rgba="1.0 0.1 0.1 1.0"/>
      </material>
    </visual>
  </link>
  
  <!-- ========== JOINT: LEFT WHEEL ========== -->
  <joint name="left_wheel_joint" type="continuous">
    <parent link="base_link"/>
    <child link="left_wheel"/>
    <axis xyz="0 1 0"/>
    <origin xyz="0 ${wheel_separation/2} ${-chassis_height/2 + wheel_radius}" 
            rpy="0 0 0"/>
    <limit effort="30" velocity="10"/>
    <dynamics damping="0.7" friction="0.0"/>
  </joint>
  
  <!-- ========== JOINT: RIGHT WHEEL ========== -->
  <joint name="right_wheel_joint" type="continuous">
    <parent link="base_link"/>
    <child link="right_wheel"/>
    <axis xyz="0 1 0"/>
    <origin xyz="0 ${-wheel_separation/2} ${-chassis_height/2 + wheel_radius}" 
            rpy="0 0 0"/>
    <limit effort="30" velocity="10"/>
    <dynamics damping="0.7" friction="0.0"/>
  </joint>
  
  <!-- ========== JOINT: CASTER WHEEL ========== -->
  <joint name="caster_wheel_joint" type="fixed">
    <parent link="base_link"/>
    <child link="caster_wheel"/>
    <origin xyz="${chassis_length/2 - caster_radius} 0 ${-chassis_height/2 + caster_radius}" 
            rpy="0 0 0"/>
  </joint>
  
  <!-- ========== JOINT: IMU ========== -->
  <joint name="imu_joint" type="fixed">
    <parent link="base_link"/>
    <child link="imu_link"/>
    <origin xyz="0 0 0" rpy="0 0 0"/>
  </joint>
  
  <!-- ========== JOINT: LASER ========== -->
  <joint name="laser_joint" type="fixed">
    <parent link="base_link"/>
    <child link="laser_link"/>
    <origin xyz="${chassis_length/2 - 0.05} 0 ${chassis_height/2 + 0.05}" 
            rpy="0 0 0"/>
  </joint>
  
</robot>
